name: Build & deploy mdBook to server

on:
  push:
    branches: ["main"]

  workflow_dispatch:

concurrency:
  group: "deploy-rrpbook"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.5.1
      DEPLOY_HOST: rrpbook.aruoshui.fun
      DEPLOY_USER: git
      DEPLOY_PORT: "22"
      DEPLOY_PATH: /www/wwwroot/rrpbook
    steps:
      - uses: actions/checkout@v4

      - name: Install mdBook
        uses: peaceiris/actions-mdbook@v2
        with:
          mdbook-version: ${{ env.MDBOOK_VERSION }}

      - name: Build with mdBook
        run: mdbook build

      - name: Setup SSH key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          if [[ -n "${{ secrets.DEPLOY_KNOWN_HOSTS }}" ]]; then
            printf '%s\n' "${{ secrets.DEPLOY_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${DEPLOY_PORT}" "${DEPLOY_HOST}" >> ~/.ssh/known_hosts
          fi

      - name: Deploy via tar over SSH
        shell: bash
        run: |
          tar -C ./book -czf - . | ssh \
            -p "${DEPLOY_PORT}" \
            -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "bash -lc 'set -euo pipefail; \
              deploy_path=\"${DEPLOY_PATH}\"; \
              mkdir -p \"${DEPLOY_PATH}\"; \
              tmp=\$(mktemp -d \"${DEPLOY_PATH}/.deploy_tmp.XXXXXX\"); \
              tar -xzf - -C \"\$tmp\" --no-same-owner --no-same-permissions; \
              rsync -r --delete --info=stats2 \
                --no-perms --no-owner --no-group --omit-dir-times --no-times \
                \"\$tmp\"/ \"${DEPLOY_PATH}\"/; \
              rm -rf \"\$tmp\"'"
